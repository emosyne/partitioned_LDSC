#https://bios25328.hakyimlab.org/post/2021/04/16/ld-score-regression/
#https://github.com/bulik/ldsc/wiki/Summary-Statistics-File-Format
#https://github.com/bulik/ldsc/wiki/Heritability-and-Genetic-Correlation
#mamut:

##PART ONE: GENERATE sumstats FILE FOR GWAS
#https://github.com/bulik/ldsc/wiki/Heritability-and-Genetic-Correlation
#use ldsc v2 (py3) for munge_sumstats, use original version for LDSC.

storage
cd ldsc_py3
conda activate ldsc3

zcat gwas/PGC3_SCZ_wave3.european.autosome.public.v3.vcf.tsv.gz | tail -n +74 |\
    gzip > gwas/PGC3_SCZ_wave3.european.autosome.public.v3.tsv.gz

munge_sumstats.py \
    --sumstats gwas/PGC3_SCZ_wave3.european.autosome.public.v3.tsv \
    --snp ID --N-cas-col NCAS --N-con-col NCON --p PVAL \
    --merge-alleles data/w_hm3.snplist \
    --out gwas/formatted_hapmap/PGC3_SCZ_wave3_european_autosome_v3_py3


#PART 2: CALCULATE Partitioned LD Scores
#https://github.com/bulik/ldsc/wiki/LD-Score-Estimation-Tutorial


# FILTER bed file WITH unique ENH
cd data/EPs/
for bedfile in *.bed
do
  echo $bedfile
  cat $bedfile | awk '!seen[$1,$2,$3]++' > uniq_$bedfile
done
# cat data/EPs/ALL_BRAIN_EPs.bed | awk -F'\t' 'BEGIN {OFS = FS} { gsub(/chr/,"", $1); print } ' | awk '!seen[$1,$2,$3]++' > data/EPs/ALL_BRAIN_EPs_nochr.bed



#Step 1: Creating an annot file for EPs
# and #Computing LD scores
storage 
cd ldsc_py2.7
conda activate ldsc

# cd data/EPs/
for CHR in {1..22}
do
  # for bedfile in uniq_*.bed
  # do
  # echo $bedfile
    echo $CHR
    #Creating an annot file for each chr
    python /mnt/storage/emanuele/ldsc_py2.7/make_annot.py \
		  --bed-file /mnt/storage/emanuele/ldsc_py2.7/data/EPs/Radina_GRBs_hg19_mm10.98.50.bed \
		  --bimfile /mnt/storage/emanuele/ldsc_py2.7/data/1000G_EUR_Phase3_plink/1000G.EUR.QC.$CHR.bim \
		  --annot-file /mnt/storage/emanuele/ldsc_py2.7/data/EPs/annot_files/Radina_GRBs_hg19_mm10.98.50.$CHR.annot.gz
  # done
  #Computing LD scores for each chr
  python /mnt/storage/emanuele/ldsc_py2.7/ldsc.py\
      --l2\
      --thin-annot\
      --bfile /mnt/storage/emanuele/ldsc_py2.7/data/1000G_EUR_Phase3_plink/1000G.EUR.QC.$CHR\
      --ld-wind-cm 1\
      --annot /mnt/storage/emanuele/ldsc_py2.7/data/EPs/annot_files/Radina_GRBs_hg19_mm10.98.50.$CHR.annot.gz\
      --out /mnt/storage/emanuele/ldsc_py2.7/data/EPs/annot_files/Radina_GRBs_hg19_mm10.98.50.$CHR
done


# Step 2: Computing LD scores with an annot file.

#this is not needed if using thin-annot later:
##add cordinates from BIM file to annot files:
# library(tidyverse)
# for(i in c(1:22)){
#   # R merge all annot files
#   (temp = list.files(pattern=paste0("*.bed.",i,".annot.gz"), 
#                      path = "/mnt/storage/emanuele/ldsc_py2.7/data/EPs/annot_files/"))
  
#   for (j in 1:length(temp)) {
#     temp[j]
#     (col.name = str_split(string = temp[j], pattern = "\\.")[[1]][1])
#     # (x= assign(temp[j], read.csv(temp[j])))
#     (bim<- data.table::fread(paste0("/mnt/storage/emanuele/ldsc_py2.7/data/1000G_EUR_Phase3_plink/1000G.EUR.QC.",i,".bim"),
#                              header = F,col.names = c("CHR","SNP" ,"CM", "BP" ,"A1","A2")) %>% 
#        dplyr::select(-A1,-A2))
    
#     (EPs_annot<-data.table::fread(paste0("/mnt/storage/emanuele/ldsc_py2.7/data/EPs/annot_files/",temp[j])))
    
#     (EPs_annot2 <- cbind( bim[,c(1,4,2,3)], EPs_annot))
#     names(EPs_annot2)[names(EPs_annot2) == "ANNOT"] <- col.name
#     head(EPs_annot2)
    
#     data.table::fwrite(
#       EPs_annot2, 
#       file = paste0("/mnt/storage/emanuele/ldsc_py2.7/data/EPs/annot_files/",temp[j]), sep = "\t"
#     )
#   }
# }




# https://github.com/bulik/ldsc/wiki/Partitioned-Heritability
## 3- The following command will allow you to partition heritability:
storage 
cd ldsc_py2.7
conda activate ldsc

python /mnt/storage/emanuele/ldsc_py2.7/ldsc.py \
	--h2 gwas/formatted_hapmap/PGC3_SCZ_wave3_european_autosome_v3_py3.sumstats.gz\
	--ref-ld-chr data/baseline_Osimo/baseline.,\
data/EPs/annot_files/sig_ES_sig_contact_EPs_in_Neural_22k_100flank.,\
data/EPs/annot_files/notNeural_20k_100flank.,\
data/EPs/annot_files/PsychENCODE_DER_03b_PFC_enhancers_18k_100flank.,\
data/EPs/annot_files/ALL_BRAIN_EPs_1569_100flank.,\
data/EPs/annot_files/Radina_GRBs_hg19_mm10.98.50.,\
data/EPs/annot_files/Harmston_GRBs_hg19_galGal4.5.\
	--w-ld-chr data/weights_Osimo/weights.\
	--overlap-annot \
	--frqfile-chr data/1000G_EUR_Phase3_plink/1000G.EUR.QC.\
	--out stratified_LDSC_out/2022_12_12_baseline_myGroups_100flank


# data/EPs/annot_files/uniq_ALL_BRAIN_EPs.bed.,
# data/EPs/annot_files/uniq_ALL_HEART_EPs.bed.,
# data/EPs/annot_files/uniq_BRAIN_EP_eQTL.bed.,
# data/EPs/annot_files/uniq_Neuron_facet_E_Ps_contact.bed.,
# data/EPs/annot_files/2022_11_08_bed_significant_ES_significant_contact_EPs_in_tissue.,
# data/EPs/annot_files/2022-11-08_bed_any_tissue_expressed_enhancers_list.\
# data/EPs/annot_files/2022-11-08_bed_34k_neg_enhs.\
# data/EPs/annot_files/all_FANTOM5_hg19_enhancers.\
# data/EPs/annot_files/PsychENCODE_DER-03b_hg19_high_confidence_PEC_enhancers.                      #18,212
# data/EPs/annot_files/PsychENCODE_enhs_also_in_FANTOM_neural_significant_ES_significant_contact.   #2,290
# data/EPs/annot_files/significant_ES_no_Neural_expression_Fantom_20k.                              #negative - not expressed in BRAIN or neural
# 100FLANK:
# data/EPs/annot_files/sig_ES_sig_contact_EPs_in_Neural_22k_100flank.,\
# data/EPs/annot_files/notNeural_20k_100flank.,\                                                    #
# data/EPs/annot_files/PsychENCODE_DER_03b_PFC_enhancers_18k_100flank.,\                            #
# data/EPs/annot_files/ALL_BRAIN_EPs_1569_100flank.
# GRBs:
# data/EPs/annot_files/Radina_GRBs_hg19_mm10.98.50.
# data/EPs/annot_files/Harmston_GRBs_hg19_galGal4.5.                                                #


# --ref-ld-chr data/baseline_Osimo/baseline.,\
#   data/EPs/annot_files/all_FANTOM5_hg19_enhancers.,\
#   data/EPs/annot_files/significant_ES_no_Neural_expression_Fantom_20k.,\
#   data/EPs/annot_files/2022-11-08_bed_any_tissue_expressed_enhancers_list.,\
#   data/EPs/annot_files/PsychENCODE_DER-03b_hg19_high_confidence_PEC_enhancers.,\
#   data/EPs/annot_files/2022_11_08_bed_significant_ES_significant_contact_EPs_in_tissue.,\
#   data/EPs/annot_files/uniq_ALL_BRAIN_EPs.bed.\




# ONLY ONCE
#update frq files
cd data/1000G_EUR_Phase3_plink
for CHR in {1..22}
do
  plink --bfile 1000G.EUR.QC.$CHR --freq --out 1000G.EUR.QC.$CHR
done

# ONLY ONCE for modified baseline
#create baseline files matched to modern BIM and my annot files
for(i in c(1:22)){
  print(i)
  (baseline_annot<-data.table::fread(paste0("/mnt/storage/emanuele/ldsc_py2.7/data/baseline/baseline.",i,".annot.gz")) %>% 
      dplyr::select(-CM)    )
  (bim<- data.table::fread(paste0("/mnt/storage/emanuele/ldsc_py2.7/data/1000G_EUR_Phase3_plink/1000G.EUR.QC.",i,".bim"),
                           header = F,col.names = c("CHR","SNP" ,"CM", "BP" ,"A1","A2")) %>% 
      dplyr::select(-A1,-A2))
  
  (EPs_annot<-data.table::fread(paste0("/mnt/storage/emanuele/ldsc_py2.7/data/EPs/ALL_BRAIN_EPs.",i,".annot.gz")))
  (EPs_annot <- cbind( bim[,c(1,4,2,3)], EPs_annot) %>% rename(EPs=ANNOT))
  
  (merge<-left_join(EPs_annot,baseline_annot, by=c("CHR","SNP" ,"BP")))
  sample_n(merge,10)
  
  # merge_match_bim<-merge[match(bim$SNP, merge$SNP),] 
  merge$base<-1
  merge[is.na(merge)] <- 0
  head(merge[,c(1:9)])
  
  nrow(bim)==nrow(merge)
  
  (base_merged <- merge %>%  select(-EPs))
  
  data.table::fwrite(
    base_merged, 
    file = paste0("/mnt/storage/emanuele/ldsc_py2.7/data/baseline_Osimo/baseline.",i,".annot.gz"), sep = "\t"
  )
}
for CHR in {1..22}
do
    echo $CHR
    python ldsc.py\
      --l2\
      --bfile data/1000G_EUR_Phase3_plink/1000G.EUR.QC.$CHR\
      --ld-wind-cm 1\
      --annot data/baseline_Osimo/baseline.$CHR.annot.gz\
      --out data/baseline_Osimo/baseline.$CHR
done
#		--print-snps data/hapmap3_snps/hm.$CHR.snp\


# ONLY ONCE unpartitioned weights
for CHR in {1..22}
do
    echo $CHR
    python ldsc.py\
      --l2\
      --bfile data/1000G_EUR_Phase3_plink/1000G.EUR.QC.$CHR\
      --ld-wind-cm 1\
      --out data/weights_Osimo/weights.$CHR
done
#		--print-snps data/hapmap3_snps/hm.$CHR.snp\


